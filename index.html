<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Güvenli Sohbet</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- reCAPTCHA -->
    <script src="https://www.google.com/recaptcha/api.js?render=6LcvPPUqAAAAACP2l6Zw3RADzkopSoe1NFQCoOLJ"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #0d0f11;
            color: #fff;
            min-height: 100vh;
            padding: 0;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .chat-container {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: #1e2023;
            border-radius: 0;
            border: none;
            overflow: hidden;
        }
        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background-color: #1a1c1e;
            border-bottom: 1px solid #333;
        }
        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column-reverse;
            gap: 1rem;
        }
        .chat-message {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }
        .chat-message .profile-pic {
            width: 32px;
            height: 32px;
            border-radius: 50%;
        }
        .chat-message-content {
            flex-grow: 1;
            text-align: left;
            word-break: break-word;
            max-width: 100%;
        }
        .chat-username {
            font-weight: 600;
            color: #ddd;
            cursor: pointer;
        }
        .chat-time {
            font-size: 0.75rem;
            color: #666;
            margin-left: auto;
        }
        .chat-input-container {
            display: flex;
            padding: 1rem;
            border-top: 1px solid #333;
            background-color: #1a1c1e;
        }
        .chat-input {
            flex-grow: 1;
            background-color: #2b2e32;
            border: 1px solid #444;
            padding: 0.75rem;
            border-radius: 8px;
            color: #fff;
            outline: none;
        }
        .chat-send-btn {
            background-color: #6a0dad;
            color: #fff;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            margin-left: 0.5rem;
            cursor: pointer;
        }
        .giveaway-container {
            background-color: #1a1c1e;
            padding: 1rem;
            border-bottom: 1px solid #333;
            display: none;
        }
        .giveaway-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }
        .giveaway-prize {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .giveaway-progress {
            height: 8px;
            background-color: #333;
            border-radius: 4px;
            margin-top: 0.5rem;
            overflow: hidden;
        }
        .giveaway-progress-bar {
            height: 100%;
            background-color: #6a0dad;
            width: 0;
            transition: width 0.1s linear;
        }
        .giveaway-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 0.5rem;
        }
        .mention {
            color: #3b82f6;
            cursor: pointer;
        }
        .mentioned-message {
            background-color: rgba(255, 165, 0, 0.2);
            border-radius: 4px;
            padding: 0.25rem;
        }
        #status { color: #ff4444; margin-top: 10px; }
        #username { margin-top: 10px; }
        .auth-container {
            background-color: #1e2023;
            padding: 2rem;
            border-radius: 12px;
            width: 300px;
            text-align: center;
        }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div id="auth-container" class="auth-container">
        <h1 class="text-2xl font-bold mb-4">Giriş Yap veya Kayıt Ol</h1>
        <input type="text" id="usernameInput" class="w-full p-2 mb-2 rounded bg-gray-800 text-white" placeholder="Kullanıcı Adı">
        <input type="password" id="password" class="w-full p-2 mb-2 rounded bg-gray-800 text-white" placeholder="Şifre">
        <button id="signUpBtn" class="w-full bg-purple-600 text-white py-2 rounded mb-2">Kayıt Ol</button>
        <button id="signInBtn" class="w-full bg-blue-600 text-white py-2 rounded">Giriş Yap</button>
        <p id="authStatus" class="text-red-500 mt-2"></p>
    </div>

    <div id="chat-container" class="chat-container hidden">
        <div class="chat-header">
            <h3 class="text-xl font-bold">Sohbet</h3>
            <button id="logoutBtn" class="text-gray-400 hover:text-white">Çıkış Yap</button>
        </div>
        <div id="giveaway-container" class="giveaway-container">
            <div class="giveaway-header">
                <img src="https://burakgtx.neocities.org/image/wl.png" alt="Golden Rain" class="w-6 h-6">
                <span>GOLDEN RAIN</span>
                <span id="giveaway-participant-count" class="ml-auto">0 %</span>
            </div>
            <div class="giveaway-prize">
                <span id="giveaway-prize-amount">0</span>
                <img src="https://burakgtx.neocities.org/image/wl.png" class="w-4 h-4">
            </div>
            <p>10 şanslı kazanana dağıtılacak</p>
            <div class="giveaway-progress">
                <div id="giveaway-progress-bar" class="giveaway-progress-bar"></div>
            </div>
            <div class="giveaway-actions">
                <button id="join-giveaway-btn" class="bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-1 px-4 rounded-full">
                    Katıl
                </button>
            </div>
        </div>
        <div id="chat-messages" class="chat-messages flex flex-col-reverse"></div>
        <div class="chat-input-container">
            <input type="text" id="input" class="chat-input" maxlength="70" placeholder="Mesaj yaz (en fazla 70 karakter)">
            <button id="send" class="chat-send-btn">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
    <p id="status" class="text-center hidden"></p>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCin2wfKkQykr3vQoVhEDjASH7mwtfkjfs",
            authDomain: "onlibeoyun.firebaseapp.com",
            databaseURL: "https://onlibeoyun-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "onlibeoyun",
            storageBucket: "onlibeoyun.firebasestorage.app",
            messagingSenderId: "388782559654",
            appId: "1:388782559654:web:4b85aa5ff4d0d65a757f67",
            measurementId: "G-WSKKZTXXBP"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        const usersRef = db.ref('users');
        const chatRef = db.ref('chat');
        const userLastMessageRef = db.ref('userLastMessage');
        const giveawayRef = db.ref('giveaway');

        const SHARED_KEY = 'xai-chat-shared-key-2025';
        const RECAPTCHA_SITE_KEY = '6LcvPPUqAAAAACP2l6Zw3RADzkopSoe1NFQCoOLJ';
        let userId, username;
        const giveawayDuration = 3 * 60 * 1000;
        let giveawayInterval = null;
        let lastSend = 0;

        // Debug engelle
        console.clear(); console.log = () => {}; console.warn = () => {}; console.error = () => {};

        // LocalStorage tek hesap kontrol
        if (localStorage.getItem('accountCreated') && !auth.currentUser) {
            document.getElementById('signUpBtn').disabled = true;
            document.getElementById('authStatus').textContent = 'Bu cihazda zaten bir hesap oluşturulmuş. Giriş yapın.';
        }

        // Otomatik giriş
        auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
        auth.onAuthStateChanged((user) => {
            if (user) {
                userId = user.uid;
                username = user.displayName || 'Kullanıcı_' + user.uid.slice(0, 8);
                document.getElementById('auth-container').classList.add('hidden');
                document.getElementById('chat-container').classList.remove('hidden');
                startChat();
            } else {
                document.getElementById('auth-container').classList.remove('hidden');
                document.getElementById('chat-container').classList.add('hidden');
            }
        });

        // reCAPTCHA fonksiyonu
        let recaptchaToken = null;
        function getRecaptchaToken(action) {
            return new Promise((resolve, reject) => {
                grecaptcha.ready(() => {
                    grecaptcha.execute(RECAPTCHA_SITE_KEY, { action: action }).then(token => {
                        if (token && token.length >= 100) {
                            recaptchaToken = token;
                            resolve(token);
                        } else {
                            reject(new Error('Geçersiz reCAPTCHA token!'));
                        }
                    }).catch(error => reject(error));
                });
            });
        }

        // Kayıt Ol
        document.getElementById('signUpBtn').addEventListener('click', async () => {
            if (localStorage.getItem('accountCreated')) return;
            try {
                const token = await getRecaptchaToken('signup');
                const usernameInput = document.getElementById('usernameInput').value;
                const password = document.getElementById('password').value;
                if (!usernameInput || !password || password.length < 6) {
                    throw new Error('Kullanıcı adı ve şifre gereklidir (şifre en az 6 karakter).');
                }

                // Kullanıcı adı benzersizlik kontrolü
                const snapshot = await usersRef.orderByChild('username').equalTo(usernameInput).once('value');
                if (snapshot.exists()) {
                    throw new Error('Bu kullanıcı adı zaten alınmış.');
                }

                // Şifreyi şifrele
                const encryptedPassword = CryptoJS.AES.encrypt(password, SHARED_KEY).toString();
                const customToken = await auth.createCustomToken(usernameInput); // Simüle edilmiş token
                const userCredential = await auth.signInWithCustomToken(customToken);
                await usersRef.child(userId).set({
                    username: usernameInput,
                    password: encryptedPassword
                });
                localStorage.setItem('accountCreated', 'true');
                auth.currentUser.updateProfile({ displayName: usernameInput });
                document.getElementById('authStatus').textContent = 'Kayıt başarılı!';
            } catch (error) {
                document.getElementById('authStatus').textContent = 'Hata: ' + error.message;
            }
        });

        // Giriş Yap
        document.getElementById('signInBtn').addEventListener('click', async () => {
            try {
                const token = await getRecaptchaToken('signin');
                const usernameInput = document.getElementById('usernameInput').value;
                const password = document.getElementById('password').value;
                const snapshot = await usersRef.orderByChild('username').equalTo(usernameInput).once('value');
                if (!snapshot.exists()) {
                    throw new Error('Kullanıcı bulunamadı.');
                }
                const userData = snapshot.val()[Object.keys(snapshot.val())[0]];
                const decryptedPassword = CryptoJS.AES.decrypt(userData.password, SHARED_KEY).toString(CryptoJS.enc.Utf8);
                if (decryptedPassword !== password) {
                    throw new Error('Yanlış şifre.');
                }
                const customToken = await auth.createCustomToken(usernameInput);
                const userCredential = await auth.signInWithCustomToken(customToken);
                auth.currentUser.updateProfile({ displayName: usernameInput });
            } catch (error) {
                document.getElementById('authStatus').textContent = 'Hata: ' + error.message;
            }
        });

        // Çıkış Yap
        document.getElementById('logoutBtn').addEventListener('click', () => {
            auth.signOut();
        });

        function startChat() {
            chatRef.on('child_added', (snapshot) => {
                const msg = snapshot.val();
                try {
                    const decryptedUser = CryptoJS.AES.decrypt(msg.user, SHARED_KEY).toString(CryptoJS.enc.Utf8);
                    const decryptedText = CryptoJS.AES.decrypt(msg.text, SHARED_KEY).toString(CryptoJS.enc.Utf8);
                    const decryptedTime = CryptoJS.AES.decrypt(msg.time, SHARED_KEY).toString(CryptoJS.enc.Utf8);
                    const timeNum = parseInt(decryptedTime);
                    if (isNaN(timeNum) || decryptedText.length > 70 || !decryptedUser || !decryptedText) return;
                    const isBot = decryptedUser === 'General Bot';
                    const profilePicUrl = isBot ? 'https://burakgtx.neocities.org/image/wl.png' : 'https://cdn.gamblit.net/profiles/Thiswackgame.webp?v=0';
                    const messageElement = document.createElement('div');
                    messageElement.classList.add('chat-message');
                    if (decryptedText.includes(`@${username}`)) {
                        messageElement.classList.add('mentioned-message');
                    }
                    messageElement.innerHTML = `
                        <img src="${profilePicUrl}" class="profile-pic" alt="${decryptedUser}">
                        <div class="chat-message-content">
                            <span class="chat-username">${decryptedUser}:</span> ${parseMentions(decryptedText)}
                        </div>
                        <span class="chat-time">${new Date(timeNum).toLocaleTimeString('tr-TR')}</span>
                    `;
                    document.getElementById('chat-messages').appendChild(messageElement);
                    messageElement.scrollIntoView();
                } catch (e) {}
            });

            giveawayRef.on('value', (snapshot) => {
                const giveawayData = snapshot.val() || {};
                const giveawayContainer = document.getElementById('giveaway-container');
                if (giveawayData.active) {
                    giveawayContainer.style.display = 'block';
                    document.getElementById('giveaway-prize-amount').textContent = giveawayData.prizeWL || 0;
                    const participantsArray = Object.keys(giveawayData.participants || {});
                    document.getElementById('giveaway-participant-count').textContent = participantsArray.length + ' %';
                    startGiveawayTimer(giveawayData.endTime);
                    checkGiveawayJoinStatus(participantsArray);
                } else {
                    giveawayContainer.style.display = 'none';
                    if (giveawayInterval) clearInterval(giveawayInterval);
                    document.getElementById('giveaway-progress-bar').style.width = '0%';
                }
            });

            let lastSend = 0;
            const sendBtn = document.getElementById('send');
            const input = document.getElementById('input');
            const status = document.getElementById('status');
            const joinGiveawayBtn = document.getElementById('join-giveaway-btn');

            sendBtn.addEventListener('click', sendMessage);
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });
            joinGiveawayBtn.addEventListener('click', handleGiveawayJoin);

            async function sendMessage() {
                const now = Date.now();
                if (now - lastSend < 3000) {
                    status.textContent = 'Mesajlar arasında 3 saniye bekle.';
                    setTimeout(() => status.textContent = '', 2000);
                    return;
                }
                const text = input.value.trim();
                if (text.length === 0 || text.length > 70) {
                    status.textContent = 'Mesaj 1-70 karakter olmalı.';
                    setTimeout(() => status.textContent = '', 2000);
                    return;
                }

                if (text.startsWith('/giveaway')) {
                    const amount = parseInt(text.split(' ')[1], 10);
                    if (isNaN(amount) || amount <= 0) {
                        status.textContent = 'Geçerli bir WL miktarı girin.';
                        setTimeout(() => status.textContent = '', 2000);
                        return;
                    }
                    await startGiveaway(amount);
                    input.value = '';
                    lastSend = now;
                    return;
                }

                const encryptedUser = CryptoJS.AES.encrypt(username, SHARED_KEY).toString();
                const encryptedText = CryptoJS.AES.encrypt(text, SHARED_KEY).toString();
                const encryptedTime = CryptoJS.AES.encrypt(now.toString(), SHARED_KEY).toString();

                userLastMessageRef.child(userId).set({ lastMessage: now });

                chatRef.push({
                    user: encryptedUser,
                    text: encryptedText,
                    time: encryptedTime
                }).then(() => {
                    input.value = '';
                    lastSend = now;
                    status.textContent = '';
                }).catch((error) => {
                    status.textContent = 'Mesaj gönderilemedi: ' + error.message;
                    setTimeout(() => status.textContent = '', 2000);
                });
            }

            async function startGiveaway(amount) {
                const endTime = Date.now() + giveawayDuration;
                giveawayRef.set({
                    active: true,
                    endTime: endTime,
                    prizeWL: amount,
                    participants: {}
                }).then(() => {
                    sendBotMessage(`Giveaway başladı! Ödül: ${amount} WL, Süre: 3 dakika. Katılmak için Join tuşuna basın.`);
                }).catch((error) => {
                    status.textContent = 'Giveaway başlatılamadı: ' + error.message;
                    setTimeout(() => status.textContent = '', 2000);
                });
            }

            function startGiveawayTimer(endTime) {
                if (giveawayInterval) clearInterval(giveawayInterval);
                const updateTimer = () => {
                    const now = Date.now();
                    const distance = endTime - now;
                    if (distance <= 0) {
                        clearInterval(giveawayInterval);
                        handleGiveawayEnd();
                        return;
                    }
                    const progress = ((giveawayDuration - distance) / giveawayDuration) * 100;
                    document.getElementById('giveaway-progress-bar').style.width = `${progress}%`;
                };
                updateTimer();
                giveawayInterval = setInterval(updateTimer, 1000);
            }

            async function handleGiveawayJoin() {
                giveawayRef.child('participants').child(userId).set(true).then(() => {
                    sendBotMessage(`${username} giveaway'a katıldı!`);
                }).catch((error) => {
                    status.textContent = 'Giveaway katılım hatası: ' + error.message;
                    setTimeout(() => status.textContent = '', 2000);
                });
            }

            async function handleGiveawayEnd() {
                giveawayRef.once('value', (snapshot) => {
                    const giveawayData = snapshot.val();
                    if (!giveawayData || !giveawayData.active) return;

                    const participantsArray = Object.keys(giveawayData.participants || {});
                    const numWinners = Math.min(10, participantsArray.length);
                    const prizePerWinner = Math.floor(giveawayData.prizeWL / numWinners) || 0;

                    const shuffled = shuffleArray(participantsArray).slice(0, numWinners);
                    let winnersList = '';
                    shuffled.forEach((winnerId, index) => {
                        winnersList += `Kullanıcı_${index + 1} (${prizePerWinner} WL)\n`;
                    });

                    sendBotMessage(`Giveaway bitti! Kazananlar:\n${winnersList}Toplam dağıtılan: ${giveawayData.prizeWL} WL`);

                    giveawayRef.set({ active: false }).catch((error) => {
                        status.textContent = 'Giveaway sonlandırma hatası: ' + error.message;
                        setTimeout(() => status.textContent = '', 2000);
                    });
                });
            }

            function sendBotMessage(text) {
                const encryptedUser = CryptoJS.AES.encrypt('General Bot', SHARED_KEY).toString();
                const encryptedText = CryptoJS.AES.encrypt(text, SHARED_KEY).toString();
                const encryptedTime = CryptoJS.AES.encrypt(Date.now().toString(), SHARED_KEY).toString();

                chatRef.push({
                    user: encryptedUser,
                    text: encryptedText,
                    time: encryptedTime
                }).catch((error) => {
                    status.textContent = 'Bot mesajı gönderilemedi: ' + error.message;
                    setTimeout(() => status.textContent = '', 2000);
                });
            }

            function checkGiveawayJoinStatus(participantsArray) {
                const joinGiveawayBtn = document.getElementById('join-giveaway-btn');
                if (participantsArray.includes(userId)) {
                    joinGiveawayBtn.textContent = 'Katıldınız';
                    joinGiveawayBtn.disabled = true;
                } else {
                    joinGiveawayBtn.textContent = 'Katıl';
                    joinGiveawayBtn.disabled = false;
                }
            }

            function parseMentions(text) {
                return text.replace(/@(\w+)/g, '<span class="mention">@$1</span>');
            }

            function shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }
        }
    </script>
</body>
</html>
