
<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gartic Phone - Eğlenceli Çizim Oyunu</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      background: linear-gradient(135deg, #a5b4fc, #e0e7ff);
      font-family: 'Inter', sans-serif;
      color: #1f2937;
      overflow-x: hidden;
    }
    canvas {
      border: 3px solid #d1d5db;
      border-radius: 16px;
      width: 100%;
      max-width: 800px; /* Çizim alanını büyüttük */
      height: auto;
      touch-action: none;
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
    }
    #chatMessages, #galleryContainer {
      max-height: 300px;
      overflow-y: auto;
      scrollbar-width: thin;
      background: #ffffff;
      border: 1px solid #e5e7eb;
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      display: inline-block;
    }
    .status-active { background-color: #22c55e; }
    .status-inactive { background-color: #ef4444; }
    .message-bubble {
      padding: 10px 14px;
      margin: 8px 0;
      border-radius: 16px;
      max-width: 80%;
      word-break: break-word;
      animation: slideIn 0.3s ease;
    }
    .message-own { background-color: #3b82f6; color: white; margin-left: auto; }
    .message-other { background-color: #e5e7eb; color: #1f2937; }
    .modal {
      background: rgba(0, 0, 0, 0.6);
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    .modal.show { opacity: 1; }
    .modal-content {
      background: white;
      border-radius: 20px;
      padding: 24px;
      width: 100%;
      max-width: 500px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
      transform: scale(0.8);
      transition: transform 0.3s ease;
    }
    .modal.show .modal-content { transform: scale(1); }
    .countdown {
      background: #3b82f6;
      color: white;
      font-size: 3.5rem;
      font-weight: bold;
      text-align: center;
      padding: 40px;
      border-radius: 20px;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.5);
      z-index: 200;
      animation: pulse 0.5s ease forwards;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
    }
    .btn {
      transition: background-color 0.2s ease, transform 0.1s ease;
      padding: 12px 24px;
      border-radius: 12px;
    }
    .btn:hover {
      filter: brightness(90%);
      transform: translateY(-2px);
    }
    .close-btn {
      position: absolute;
      top: 16px;
      right: 16px;
      font-size: 28px;
      cursor: pointer;
      color: #6b7280;
    }
    .close-btn:hover { color: #1f2937; }
    .drawing-tools {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 16px;
      background: #f9fafb;
      padding: 16px;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
    }
    .tool-btn {
      padding: 10px 16px;
      border-radius: 10px;
      cursor: pointer;
      background: #e5e7eb;
      color: #1f2937;
      transition: background-color 0.2s ease;
    }
    .tool-btn.active {
      background-color: #3b82f6;
      color: white;
    }
    .color-picker {
      width: 40px;
      height: 40px;
      border: 2px solid #d1d5db;
      border-radius: 8px;
      padding: 0;
      cursor: pointer;
    }
    #galleryContainer {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #galleryContainer .gallery-item {
      display: flex;
      align-items: center;
      width: 100%;
      max-width: 800px; /* Resim alanını büyüttük */
      margin: 16px 0;
    }
    #galleryContainer img {
      max-width: 400px; /* Resmi büyüttük */
      border-radius: 12px;
      margin-right: 20px;
      transition: transform 0.3s ease;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    #galleryContainer img:hover {
      transform: scale(1.1);
    }
    .gallery-info {
      flex-grow: 1;
    }
    .progress-bar {
      width: 100%;
      height: 10px;
      background: #e5e7eb;
      border-radius: 6px;
      overflow: hidden;
      margin-top: 12px;
    }
    .progress-bar-fill {
      height: 100%;
      background: #22c55e;
      transition: width 0.3s ease;
    }
    .player-list {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
    }
    .player-list-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 0;
    }
    @keyframes slideIn {
      from { transform: translateX(-30px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes pulse {
      0% { transform: translate(-50%, -50%) scale(0.5); }
      50% { transform: translate(-50%, -50%) scale(1.3); }
      100% { transform: translate(-50%, -50%) scale(1); }
    }
    @media (max-width: 768px) {
      #authScreen, #lobby, #verificationScreen { max-width: 95%; }
      #gameContainer { flex-direction: column; }
      #chatMessages, #galleryContainer { max-height: 250px; }
      canvas { max-width: 100%; }
      .modal-content { max-width: 90%; }
      .countdown { font-size: 2.5rem; padding: 24px; }
      .btn { padding: 10px 20px; }
      #galleryContainer img { max-width: 100%; }
    }
  </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-6">
  <!-- Kayıt/Giriş Ekranı -->
  <div id="authScreen" class="bg-white rounded-3xl shadow-2xl p-10 w-full max-w-md">
    <h1 class="text-4xl font-extrabold text-gray-800 mb-10 text-center">Gartic Phone</h1>
    <div id="registerForm">
      <input id="registerUsername" type="text" placeholder="Kullanıcı Adı" class="w-full p-4 border rounded-xl mb-5 focus:ring-2 focus:ring-blue-500" autocomplete="off" />
      <input id="registerEmail" type="email" placeholder="E-posta" class="w-full p-4 border rounded-xl mb-5 focus:ring-2 focus:ring-blue-500" autocomplete="off" />
      <input id="registerPassword" type="password" placeholder="Şifre (min. 8 karakter)" class="w-full p-4 border rounded-xl mb-5 focus:ring-2 focus:ring-blue-500" autocomplete="new-password" />
      <button onclick="register()" class="w-full bg-blue-600 text-white p-4 rounded-xl hover:bg-blue-700 btn">Kayıt Ol</button>
      <p class="text-center mt-6 text-gray-600">Hesabın var mı? <a href="#" onclick="showLoginForm()" class="text-blue-500 hover:underline">Giriş Yap</a></p>
    </div>
    <div id="loginForm" class="hidden">
      <input id="loginEmail" type="email" placeholder="E-posta" class="w-full p-4 border rounded-xl mb-5 focus:ring-2 focus:ring-blue-500" autocomplete="off" />
      <input id="loginPassword" type="password" placeholder="Şifre" class="w-full p-4 border rounded-xl mb-5 focus:ring-2 focus:ring-blue-500" autocomplete="new-password" />
      <button onclick="login()" class="w-full bg-green-600 text-white p-4 rounded-xl hover:bg-green-700 btn">Giriş Yap</button>
      <p class="text-center mt-6 text-gray-600">Şifreni mi unuttun? <a href="#" onclick="resetPassword()" class="text-blue-500 hover:underline">Şifremi Unuttum</a></p>
      <p class="text-center mt-3 text-gray-600">Hesabın yok mu? <a href="#" onclick="showRegisterForm()" class="text-blue-500 hover:underline">Kayıt Ol</a></p>
    </div>
  </div>

  <!-- E-posta Doğrulama Bekleme Ekranı -->
  <div id="verificationScreen" class="hidden bg-white rounded-3xl shadow-2xl p-10 w-full max-w-md">
    <h1 class="text-4xl font-extrabold text-gray-800 mb-8 text-center">E-posta Doğrulama</h1>
    <p class="text-gray-600 mb-8 text-center">Lütfen e-posta adresinize gönderilen doğrulama bağlantısına tıklayın.</p>
    <button id="resendVerification" onclick="resendVerificationEmail()" class="w-full bg-blue-600 text-white p-4 rounded-xl hover:bg-blue-700 btn mb-5">Tekrar Gönder</button>
    <button onclick="logout()" class="w-full bg-red-600 text-white p-4 rounded-xl hover:bg-red-700 btn">Çıkış Yap</button>
  </div>

  <!-- Ana Sayfa (Lobi) -->
  <div id="lobby" class="hidden w-full max-w-lg">
    <h1 class="text-4xl font-extrabold text-gray-800 mb-10 text-center">Hoş Geldin, <span id="welcomeUsername"></span>!</h1>
    <div class="grid grid-cols-1 gap-5">
      <button onclick="showRoomsModal()" class="bg-blue-600 text-white p-5 rounded-xl hover:bg-blue-700 btn">Odalar</button>
      <button onclick="showCreateRoomModal()" class="bg-green-600 text-white p-5 rounded-xl hover:bg-green-700 btn">Oda Oluştur</button>
      <button onclick="showInviteCodeMenu()" class="bg-purple-600 text-white p-5 rounded-xl hover:bg-purple-700 btn">Davet Kodu ile Katıl</button>
      <button onclick="logout()" class="bg-red-600 text-white p-5 rounded-xl hover:bg-red-700 btn">Çıkış Yap</button>
    </div>
    <div id="inviteCodeMenu" class="hidden mt-5">
      <input id="inviteCode" type="text" placeholder="Davet Kodu (ör: ABC123)" class="w-full p-4 border rounded-xl mb-4 focus:ring-2 focus:ring-purple-500" autocomplete="off" />
      <button onclick="joinRoomByInviteCode()" class="w-full bg-purple-600 text-white p-4 rounded-xl hover:bg-purple-700 btn">Odaya Katıl</button>
    </div>
  </div>

  <!-- Oyun Ekranı -->
  <div id="gameContainer" class="hidden w-full max-w-6xl">
    <div id="countdown" class="hidden countdown"></div>
    <div class="flex justify-between items-center mb-8">
      <h2 id="currentRoom" class="text-3xl font-bold text-gray-800"></h2>
      <div class="flex items-center space-x-6">
        <span id="playerCount" class="text-gray-700 font-semibold"></span>
        <span class="text-gray-700">Sunucu: <span id="serverStatus" class="status-indicator"></span></span>
      </div>
    </div>
    <div class="player-list" id="playerList">
      <h3 class="text-xl font-semibold text-gray-800 mb-4">Oyuncular (Maks. 6)</h3>
      <div id="playerListItems"></div>
    </div>
    <div class="flex flex-col md:flex-row space-y-8 md:space-y-0 md:space-x-8">
      <div class="flex-1">
        <div id="gameState" class="text-gray-700 text-2xl mb-4 font-semibold"></div>
        <div id="timer" class="text-gray-700 text-xl mb-4"></div>
        <button id="startGameButton" onclick="startGameFromButton()" class="hidden bg-green-600 text-white p-4 rounded-xl hover:bg-green-700 btn mb-4">Oyunu Başlat</button>
        <div id="drawingArea" class="relative">
          <div class="drawing-tools">
            <button class="tool-btn active" onclick="setTool('brush')">Fırça</button>
            <button class="tool-btn" onclick="setTool('eraser')">Silgi</button>
            <input type="range" id="brushSize" min="1" max="30" value="5" class="w-28">
            <input type="color" id="brushColor" value="#000000" class="color-picker">
            <button class="tool-btn" onclick="clearCanvas()">Temizle</button>
          </div>
          <div id="promptDisplay" class="text-xl font-semibold text-blue-600 mb-3 hidden"></div>
          <canvas id="gameCanvas" width="800" height="600" class="rounded-3xl shadow-2xl"></canvas> <!-- Büyüttük -->
          <button id="submitDrawing" onclick="submitDrawing()" class="hidden bg-blue-600 text-white p-4 rounded-xl hover:bg-blue-700 btn mt-4">Çizimi Onayla</button>
          <div id="approvalCount" class="hidden text-gray-700 mt-4">
            Onay Durumu: <span id="approvedCount">0</span>/<span id="totalPlayers"></span>
            <div class="progress-bar">
              <div id="progressBarFill" class="progress-bar-fill" style="width: 0%"></div>
            </div>
          </div>
        </div>
        <div id="promptArea" class="hidden mt-4">
          <input id="promptInput" type="text" placeholder="İpucu yaz (max 50 karakter)" maxlength="50" class="w-full p-4 border rounded-xl mb-4 focus:ring-2 focus:ring-blue-500" autocomplete="off" />
          <button id="submitPrompt" onclick="submitPrompt()" class="bg-blue-600 text-white p-4 rounded-xl hover:bg-blue-700 btn">İpucunu Gönder</button>
        </div>
        <div id="galleryArea" class="hidden mt-4">
          <div id="galleryContainer" class="mb-4"></div>
          <button id="startNewRound" onclick="startNewRound()" class="hidden bg-green-600 text-white p-4 rounded-xl hover:bg-green-700 btn">Yeni Tur</button>
        </div>
        <button onclick="copyInviteCode()" class="mt-4 bg-purple-600 text-white p-4 rounded-xl hover:bg-purple-700 btn">Davet Kodunu Kopyala</button>
      </div>
      <div class="w-full md:w-1/3">
        <h3 class="text-xl font-semibold text-gray-800 mb-4">Sohbet</h3>
        <div id="chatMessages" class="mb-4"></div>
        <input id="chatInput" type="text" placeholder="Mesaj yaz (max 50 karakter)" maxlength="50" class="w-full p-4 border rounded-xl mb-4 focus:ring-2 focus:ring-green-500" autocomplete="off" />
        <button onclick="sendMessage()" class="w-full bg-green-600 text-white p-4 rounded-xl hover:bg-green-700 btn">Gönder</button>
      </div>
    </div>
    <button onclick="leaveRoom()" class="mt-8 bg-red-600 text-white p-4 rounded-xl hover:bg-red-700 btn">Odadan Çık</button>
  </div>

  <!-- Modallar -->
  <div id="roomsModal" class="modal hidden">
    <div class="modal-content relative">
      <span class="close-btn" onclick="hideRoomsModal()">×</span>
      <h2 class="text-2xl font-bold mb-6">Mevcut Odalar</h2>
      <input id="roomSearch" type="text" placeholder="Oda adı ara..." class="w-full p-4 border rounded-xl mb-5 focus:ring-2 focus:ring-blue-500" autocomplete="off" oninput="filterRooms()" />
      <ul id="roomList" class="space-y-4 max-h-96 overflow-y-auto"></ul>
    </div>
  </div>
  <div id="createRoomModal" class="modal hidden">
    <div class="modal-content">
      <h2 class="text-2xl font-bold mb-6">Yeni Oda Oluştur</h2>
      <input id="modalRoomName" type="text" placeholder="Oda Adı" maxlength="15" class="w-full p-4 border rounded-xl mb-4 focus:ring-2 focus:ring-blue-500" autocomplete="off" />
      <select id="modalRoomTheme" class="w-full p-4 border rounded-xl mb-4 focus:ring-2 focus:ring-blue-500">
        <option value="default">Varsayılan</option>
        <option value="funny">Komik</option>
        <option value="creative">Yaratıcı</option>
      </select>
      <label class="flex items-center mb-4">
        <input id="modalRoomPasswordToggle" type="checkbox" class="mr-3" onclick="togglePasswordInput()" />
        Şifre Kullan
      </label>
      <input id="modalRoomPassword" type="password" placeholder="Oda Şifresi" class="w-full p-4 border rounded-xl mb-4 focus:ring-2 focus:ring-blue-500 hidden" autocomplete="new-password" />
      <div class="flex justify-between">
        <button onclick="hideCreateRoomModal()" class="bg-gray-600 text-white p-4 rounded-xl hover:bg-gray-700 btn">Geri</button>
        <button onclick="createRoomFromModal()" class="bg-blue-600 text-white p-4 rounded-xl hover:bg-blue-700 btn">Oluştur</button>
      </div>
    </div>
  </div>
  <div id="joinRoomModal" class="modal hidden">
    <div class="modal-content">
      <h2 class="text-2xl font-bold mb-6">Odaya Katıl</h2>
      <p class="text-gray-600 mb-4">Oda: <span id="joinRoomName"></span></p>
      <input id="joinRoomPassword" type="password" placeholder="Oda Şifresi" class="w-full p-4 border rounded-xl mb-4 focus:ring-2 focus:ring-blue-500" autocomplete="new-password" />
      <div class="flex justify-between">
        <button onclick="hideJoinRoomModal()" class="bg-gray-600 text-white p-4 rounded-xl hover:bg-gray-700 btn">Geri</button>
        <button onclick="joinRoomFromModal()" class="bg-blue-600 text-white p-4 rounded-xl hover:bg-blue-700 btn">Katıl</button>
      </div>
    </div>
  </div>
  <div id="settingsModal" class="modal hidden">
    <div class="modal-content relative">
      <span class="close-btn" onclick="hideSettingsModal()">×</span>
      <h2 class="text-2xl font-bold mb-6">Ayarlar</h2>
      <button onclick="requestAccountDeletion()" class="w-full bg-red-600 text-white p-4 rounded-xl hover:bg-red-700 btn">Hesabı Sil</button>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-analytics.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCin2wfKkQykr3vQoVhEDjASH7mwtfkjfs",
      authDomain: "onlibeoyun.firebaseapp.com",
      databaseURL: "https://onlibeoyun-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "onlibeoyun",
      storageBucket: "onlibeoyun.firebasestorage.app",
      messagingSenderId: "388782559654",
      appId: "1:388782559654:web:4b85aa5ff4d0d65a757f67",
      measurementId: "G-WSKKZTXXBP"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const database = firebase.database();
    const analytics = firebase.analytics();

    let playerId = null;
    let playerName = null;
    let currentRoomId = null;
    let lastVerificationSent = 0;
    let lastMessageTime = 0;
    const VERIFICATION_COOLDOWN = 5 * 60 * 1000;
    const MESSAGE_COOLDOWN = 5 * 1000;
    const MAX_PLAYERS = 6;

    const urlParams = new URLSearchParams(window.location.search);
    const roomIdFromUrl = urlParams.get('roomId');

    const CANVAS_WIDTH = 800; // Büyüttük
    const CANVAS_HEIGHT = 600; // Büyüttük

    function lockCanvasSize() {
      const canvas = document.getElementById('gameCanvas');
      canvas.width = CANVAS_WIDTH;
      canvas.height = CANVAS_HEIGHT;
      canvas.style.width = '100%';
      canvas.style.maxWidth = `${CANVAS_WIDTH}px`;
      canvas.style.height = 'auto';
    }

    window.addEventListener('resize', lockCanvasSize);
    window.addEventListener('load', lockCanvasSize);

    function generateInviteCode() {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      let code = '';
      for (let i = 0; i < 6; i++) {
        code += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return code;
    }

    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    function assignPrompts(players, submissions) {
      const playerIds = [...players];
      const shuffledIds = shuffleArray([...playerIds]);
      const assignments = {};
      for (let i = 0; i < playerIds.length; i++) {
        const receiver = playerIds[i];
        const sender = shuffledIds[i];
        assignments[receiver] = submissions[sender]?.prompt || 'Bir şeyler çiz!';
      }
      return assignments;
    }

    function register() {
      const username = document.getElementById('registerUsername').value.trim();
      const email = document.getElementById('registerEmail').value.trim();
      const password = document.getElementById('registerPassword').value;
      if (!username || !email || !password) {
        alert('Lütfen tüm alanları doldurun!');
        return;
      }
      if (!/^[a-zA-Z0-9_]+$/.test(username) || username.length > 20) {
        alert('Kullanıcı adı yalnızca harf, rakam ve alt çizgi içerebilir, 20 karakterden uzun olamaz!');
        return;
      }
      if (!/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(email)) {
        alert('Geçerli bir e-posta adresi girin!');
        return;
      }
      if (password.length < 8) {
        alert('Şifre en az 8 karakter olmalı!');
        return;
      }

      auth.createUserWithEmailAndPassword(email, password)
        .then((userCredential) => {
          playerId = userCredential.user.uid;
          playerName = username;
          return database.ref('usernames').child(username.toLowerCase()).once('value')
            .then((snapshot) => {
              if (snapshot.exists()) {
                throw new Error('Bu kullanıcı adı zaten alınmış!');
              }
              return database.ref(`users/${playerId}`).set({
                username: username,
                usernameLower: username.toLowerCase(),
                email: email,
                createdRooms: 0
              });
            })
            .then(() => {
              return database.ref(`usernames/${username.toLowerCase()}`).set(playerId);
            })
            .then(() => {
              return auth.currentUser.sendEmailVerification();
            })
            .then(() => {
              lastVerificationSent = Date.now();
              alert('Kayıt başarılı! Lütfen e-postanızı doğrulayın.');
              showVerificationScreen();
            });
        })
        .catch((error) => {
          if (auth.currentUser) {
            auth.currentUser.delete().catch(() => {});
          }
          alert(error.message === 'Bu kullanıcı adı zaten alınmış!' ? error.message : error.code === 'auth/email-already-in-use' ? 'Bu e-posta adresi zaten kayıtlı!' : `Hata: ${error.message}`);
        });
    }

    function showVerificationScreen() {
      document.getElementById('authScreen').style.display = 'none';
      document.getElementById('verificationScreen').style.display = 'block';
      document.getElementById('lobby').style.display = 'none';
      document.getElementById('gameContainer').style.display = 'none';
    }

    function resendVerificationEmail() {
      const now = Date.now();
      if (now - lastVerificationSent < VERIFICATION_COOLDOWN) {
        const remaining = Math.ceil((VERIFICATION_COOLDOWN - (now - lastVerificationSent)) / 1000);
        alert(`Lütfen ${remaining} saniye bekleyin ve tekrar deneyin.`);
        return;
      }
      if (!auth.currentUser) {
        alert('Lütfen önce giriş yapın!');
        return;
      }
      auth.currentUser.sendEmailVerification()
        .then(() => {
          lastVerificationSent = Date.now();
          alert('Doğrulama e-postası gönderildi! E-postanızı (ve spam klasörünü) kontrol edin.');
        })
        .catch((error) => {
          alert(`Hata: Doğrulama e-postası gönderilemedi. ${error.message}`);
        });
    }

    function login() {
      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPassword').value;
      if (!email || !password) {
        alert('Lütfen e-posta ve şifre girin!');
        return;
      }

      auth.signInWithEmailAndPassword(email, password)
        .then((userCredential) => {
          if (!userCredential.user.emailVerified) {
            showVerificationScreen();
            return;
          }
          playerId = userCredential.user.uid;
          database.ref(`users/${playerId}`).once('value', (snapshot) => {
            if (snapshot.exists()) {
              playerName = snapshot.val().username;
              if (!playerName) {
                alert('Kullanıcı adı bulunamadı! Lütfen tekrar kayıt olun.');
                auth.signOut();
                return;
              }
              document.getElementById('welcomeUsername').textContent = playerName;
              document.getElementById('authScreen').style.display = 'none';
              document.getElementById('verificationScreen').style.display = 'none';
              document.getElementById('lobby').style.display = 'block';
              checkUrlAndJoin();
            } else {
              alert('Kullanıcı verileri bulunamadı!');
              auth.signOut();
            }
          });
        })
        .catch((error) => {
          alert(error.code === 'auth/wrong-password' ? 'Yanlış şifre!' : error.code === 'auth/user-not-found' ? 'Bu e-posta adresiyle kayıtlı bir hesap bulunamadı!' : `Hata: ${error.message}`);
        });
    }

    function resetPassword() {
      const email = prompt('E-posta adresinizi girin:');
      if (!email) {
        alert('Lütfen bir e-posta adresi girin!');
        return;
      }
      if (!/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(email)) {
        alert('Geçerli bir e-posta adresi girin!');
        return;
      }
      auth.sendPasswordResetEmail(email)
        .then(() => {
          alert('Şifre sıfırlama e-postası gönderildi! E-postanızı (ve spam klasörünü) kontrol edin.');
        })
        .catch((error) => {
          alert(error.code === 'auth/user-not-found' ? 'Bu e-posta adresiyle kayıtlı bir hesap bulunamadı!' : `Hata: ${error.message}`);
        });
    }

    function logout() {
      auth.signOut().then(() => {
        playerId = null;
        playerName = null;
        currentRoomId = null;
        document.getElementById('lobby').style.display = 'none';
        document.getElementById('gameContainer').style.display = 'none';
        document.getElementById('authScreen').style.display = 'block';
        document.getElementById('verificationScreen').style.display = 'none';
        showLoginForm();
      });
    }

    function showLoginForm() {
      document.getElementById('registerForm').classList.add('hidden');
      document.getElementById('loginForm').classList.remove('hidden');
    }

    function showRegisterForm() {
      document.getElementById('loginForm').classList.add('hidden');
      document.getElementById('registerForm').classList.remove('hidden');
    }

    function showModal(modalId) {
      const modal = document.getElementById(modalId);
      modal.classList.remove('hidden');
      setTimeout(() => modal.classList.add('show'), 10);
    }

    function hideModal(modalId) {
      const modal = document.getElementById(modalId);
      modal.classList.remove('show');
      setTimeout(() => modal.classList.add('hidden'), 300);
    }

    function showRoomsModal() {
      showModal('roomsModal');
      document.getElementById('roomSearch').value = '';
      listRooms();
    }

    function hideRoomsModal() {
      hideModal('roomsModal');
    }

    function filterRooms() {
      const search = document.getElementById('roomSearch').value.trim().toLowerCase();
      const roomList = document.getElementById('roomList');
      const items = roomList.getElementsByTagName('li');
      for (let item of items) {
        const roomName = item.querySelector('.room-name').textContent.toLowerCase();
        item.style.display = roomName.includes(search) ? '' : 'none';
      }
    }

    function showCreateRoomModal() {
      showModal('createRoomModal');
      document.getElementById('modalRoomName').value = '';
      document.getElementById('modalRoomTheme').value = 'default';
      document.getElementById('modalRoomPasswordToggle').checked = false;
      document.getElementById('modalRoomPassword').classList.add('hidden');
      document.getElementById('modalRoomPassword').value = '';
    }

    function hideCreateRoomModal() {
      hideModal('createRoomModal');
    }

    function togglePasswordInput() {
      const passwordInput = document.getElementById('modalRoomPassword');
      passwordInput.classList.toggle('hidden', !document.getElementById('modalRoomPasswordToggle').checked);
    }

    function createRoomFromModal() {
      const roomName = document.getElementById('modalRoomName').value.trim();
      const theme = document.getElementById('modalRoomTheme').value;
      const passwordToggle = document.getElementById('modalRoomPasswordToggle').checked;
      const password = passwordToggle ? document.getElementById('modalRoomPassword').value : '';
      if (!roomName || roomName.length > 15) {
        alert('Lütfen geçerli bir oda adı girin (max 15 karakter)!');
        return;
      }

      database.ref(`users/${playerId}`).once('value', (snapshot) => {
        const userData = snapshot.val();
        const createdRooms = userData.createdRooms || 0;
        if (createdRooms >= 2) {
          alert('En fazla 2 oda oluşturabilirsiniz!');
          return;
        }

        const roomId = Date.now().toString();
        const inviteCode = generateInviteCode();
        const roomRef = database.ref(`rooms/${roomId}`);
        roomRef.set({
          name: roomName,
          createdAt: firebase.database.ServerValue.TIMESTAMP,
          owner: playerName,
          ownerId: playerId,
          theme: theme,
          password: password,
          inviteCode: inviteCode,
          players: {
            [playerId]: { name: playerName, online: true }
          },
          gameState: {
            phase: 'waiting',
            round: 0,
            currentTurn: 0,
            playersOrder: [playerId],
            countdown: 0
          }
        }).then(() => {
          database.ref(`users/${playerId}`).update({ createdRooms: createdRooms + 1 });
          hideCreateRoomModal();
          joinRoom(roomId, roomName, theme);
        }).catch((error) => {
          console.error('Oda oluşturma hatası:', error);
          alert('Oda oluşturulamadı: ' + error.message);
        });
      });
    }

    function showJoinRoomModal(roomId, roomName, theme) {
      showModal('joinRoomModal');
      document.getElementById('joinRoomName').textContent = roomName;
      document.getElementById('joinRoomPassword').value = '';
      window.joinRoomData = { roomId, roomName, theme };
    }

    function hideJoinRoomModal() {
      hideModal('joinRoomModal');
      window.joinRoomData = null;
    }

    function joinRoomFromModal() {
      const password = document.getElementById('joinRoomPassword').value;
      const { roomId, roomName, theme } = window.joinRoomData || {};
      if (!roomId) {
        alert('Oda bilgisi eksik!');
        return;
      }
      database.ref(`rooms/${roomId}/password`).once('value', (snapshot) => {
        const correctPassword = snapshot.val();
        if (correctPassword && password !== correctPassword) {
          alert('Yanlış şifre!');
          return;
        }
        database.ref(`rooms/${roomId}/players`).once('value', (snapshot) => {
          const playerCount = Object.values(snapshot.val() || {}).filter(p => p.online).length;
          if (playerCount >= MAX_PLAYERS) {
            alert('Bu oda dolu! Maksimum 6 oyuncu olabilir.');
            return;
          }
          hideJoinRoomModal();
          joinRoom(roomId, roomName, theme);
        });
      });
    }

    function showSettingsModal() {
      showModal('settingsModal');
    }

    function hideSettingsModal() {
      hideModal('settingsModal');
    }

    function requestAccountDeletion() {
      if (!confirm('Hesabınızı silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.')) {
        return;
      }
      if (!auth.currentUser) {
        alert('Lütfen önce giriş yapın!');
        return;
      }
      database.ref(`users/${playerId}`).once('value', (snapshot) => {
        const email = snapshot.val().email;
        alert(`Hesap silme talebiniz alındı. ${email} adresinize bir doğrulama e-postası gönderildi. (Demo amaçlı)\nNot: Gerçek silme için yöneticiyle iletişime geçin.`);
        hideSettingsModal();
        logout();
      });
    }

    function showInviteCodeMenu() {
      const menu = document.getElementById('inviteCodeMenu');
      menu.classList.toggle('hidden');
      if (!menu.classList.contains('hidden')) {
        document.getElementById('inviteCode').focus();
      }
    }

    function checkServerStatus() {
      database.ref('.info/connected').on('value', (snapshot) => {
        const statusIndicator = document.getElementById('serverStatus');
        if (snapshot.val() === true) {
          statusIndicator.classList.remove('status-inactive');
          statusIndicator.classList.add('status-active');
        } else {
          statusIndicator.classList.remove('status-active');
          statusIndicator.classList.add('status-inactive');
        }
      });
    }

    function joinRoom(roomId, roomName, theme) {
      if (!playerId || !auth.currentUser || playerId !== auth.currentUser.uid || !playerName) {
        alert('Oturum hatası veya kullanıcı adı eksik! Lütfen tekrar giriş yapın.');
        logout();
        return;
      }

      database.ref(`rooms/${roomId}/players`).once('value', (snapshot) => {
        const playerCount = Object.values(snapshot.val() || {}).filter(p => p.online).length;
        if (playerCount >= MAX_PLAYERS) {
          alert('Bu oda dolu! Maksimum 6 oyuncu olabilir.');
          return;
        }

        currentRoomId = roomId;
        document.getElementById('lobby').style.display = 'none';
        document.getElementById('gameContainer').style.display = 'block';
        document.getElementById('currentRoom').textContent = `Oda: ${roomName}`;

        const playerRef = database.ref(`rooms/${roomId}/players/${playerId}`);
        const playerData = { name: playerName, online: true };
        playerRef.update(playerData)
          .then(() => {
            playerRef.onDisconnect().update({ online: false });
            database.ref(`rooms/${roomId}/gameState/playersOrder`).transaction((currentOrder) => {
              if (!currentOrder) return [playerId];
              if (!currentOrder.includes(playerId)) return [...currentOrder, playerId];
              return currentOrder;
            });
            startGame(roomId, theme);
            startChat(roomId);
            updatePlayerCount(roomId);
            updatePlayerList(roomId);
            checkServerStatus();
            setInterval(() => {
              if (currentRoomId && playerId) {
                database.ref(`rooms/${currentRoomId}/players/${playerId}`).update({ online: true });
              }
            }, 30000);
          })
          .catch((error) => {
            console.error('Oyuncu ekleme hatası:', error);
            alert('Odaya katılamadınız: ' + error.message);
            leaveRoom();
          });
      });
    }

    function joinRoomByInviteCode() {
      const code = document.getElementById('inviteCode').value.trim().toUpperCase();
      if (!code) {
        alert('Lütfen bir davet kodu girin!');
        return;
      }

      database.ref('rooms').orderByChild('inviteCode').equalTo(code).once('value', (snapshot) => {
        if (!snapshot.exists()) {
          alert('Geçersiz davet kodu!');
          return;
        }
        snapshot.forEach((childSnapshot) => {
          const roomId = childSnapshot.key;
          const roomData = childSnapshot.val();
          if (roomData.password) {
            showJoinRoomModal(roomId, roomData.name, roomData.theme);
          } else {
            joinRoom(roomId, roomData.name, roomData.theme);
          }
        });
      }).catch((error) => {
        console.error('Davet kodu sorgu hatası:', error);
        alert(error.code === 'PERMISSION_DENIED' ? 'Davet kodu ile odaya katılma izniniz yok. Lütfen giriş yaptığınızdan emin olun.' : `Hata: ${error.message}`);
      });
    }

    function leaveRoom() {
      if (currentRoomId && playerId) {
        database.ref(`rooms/${currentRoomId}/players/${playerId}`).update({ online: false });
        database.ref(`rooms/${currentRoomId}/gameState/playersOrder`).transaction((currentOrder) => {
          if (currentOrder) {
            return currentOrder.filter(id => id !== playerId);
          }
          return currentOrder;
        });
        currentRoomId = null;
        document.getElementById('gameContainer').style.display = 'none';
        document.getElementById('lobby').style.display = 'block';
        document.getElementById('chatMessages').innerHTML = '';
        document.getElementById('galleryContainer').innerHTML = '';
        window.history.pushState({}, document.title, window.location.pathname);
      }
    }

    function copyInviteCode() {
      if (!currentRoomId) return;
      database.ref(`rooms/${currentRoomId}/inviteCode`).once('value', (snapshot) => {
        const code = snapshot.val();
        navigator.clipboard.writeText(code).then(() => {
          alert('Davet kodu kopyalandı!');
        });
      });
    }

    function listRooms() {
      const roomList = document.getElementById('roomList');
      roomList.innerHTML = '';
      database.ref('rooms').on('value', (snapshot) => {
        roomList.innerHTML = '';
        snapshot.forEach((childSnapshot) => {
          const roomId = childSnapshot.key;
          const roomData = childSnapshot.val();
          let playerCount = 0;
          if (roomData.players) {
            Object.values(roomData.players).forEach(player => {
              if (player.online) playerCount++;
            });
          }
          const li = document.createElement('li');
          li.className = 'p-5 bg-gray-100 rounded-xl shadow-sm hover:bg-gray-200 transition-colors';
          li.innerHTML = `
            <div class="text-xl font-semibold room-name">${roomData.name}</div>
            <div class="text-gray-600 text-sm">Oluşturan: ${roomData.owner}</div>
            <div class="text-gray-600 text-sm">Tema: ${roomData.theme === 'funny' ? 'Komik' : roomData.theme === 'creative' ? 'Yaratıcı' : 'Varsayılan'}</div>
            <div class="text-gray-600 text-sm">Oyuncu Sayısı: ${playerCount}/${MAX_PLAYERS}</div>
            <button onclick="promptForPassword('${roomId}', '${roomData.name}', '${roomData.theme}')" class="mt-3 bg-blue-600 text-white px-5 py-3 rounded-xl hover:bg-blue-700 btn">Katıl</button>
          `;
          roomList.appendChild(li);
        });
        filterRooms();
      }, (error) => {
        console.error('Odaları listeleme hatası:', error);
        alert(error.code === 'PERMISSION_DENIED' ? 'Odaları görüntüleme izniniz yok. Lütfen giriş yaptığınızdan emin olun.' : `Odaları listeleme hatası: ${error.message}`);
      });
    }

    function promptForPassword(roomId, roomName, theme) {
      database.ref(`rooms/${roomId}/password`).once('value', (snapshot) => {
        const password = snapshot.val();
        if (password) {
          showJoinRoomModal(roomId, roomName, theme);
        } else {
          joinRoom(roomId, roomName, theme);
        }
      });
    }

    function checkUrlAndJoin() {
      if (roomIdFromUrl && playerId) {
        database.ref(`rooms/${roomIdFromUrl}`).once('value', (snapshot) => {
          if (snapshot.exists()) {
            promptForPassword(roomIdFromUrl, snapshot.val().name, snapshot.val().theme);
          } else {
            alert('Bu oda bulunamadı!');
          }
        });
      } else if (roomIdFromUrl && !playerId) {
        document.getElementById('authScreen').style.display = 'block';
        document.getElementById('lobby').style.display = 'none';
        document.getElementById('gameContainer').style.display = 'none';
      }
    }

    function startGameFromButton() {
      if (!currentRoomId) {
        alert('Hata: Oda bulunamadı!');
        return;
      }
      database.ref(`rooms/${currentRoomId}/gameState`).once('value', (snapshot) => {
        const state = snapshot.val();
        if (state.phase !== 'waiting') {
          alert('Oyun zaten başladı!');
          return;
        }
        database.ref(`rooms/${currentRoomId}/players`).once('value', (playersSnapshot) => {
          const playerCount = Object.values(playersSnapshot.val() || {}).filter(p => p.online).length;
          if (playerCount < 2) {
            alert('Oyunu başlatmak için en az 2 oyuncu gerekli! Şu anki oyuncu sayısı: ' + playerCount);
            return;
          }
          database.ref(`rooms/${currentRoomId}/gameState`).update({
            countdown: 3
          }).then(() => {
            alert('Oyun başlatılıyor...');
            startCountdown(currentRoomId);
          }).catch((error) => {
            alert('Oyun başlatılamadı: ' + error.message);
          });
        });
      });
    }

    function startCountdown(roomId) {
      const countdown = document.getElementById('countdown');
      let countdownInterval;

      database.ref(`rooms/${roomId}/gameState/countdown`).on('value', (snapshot) => {
        const count = snapshot.val();
        if (count > 0) {
          countdown.classList.remove('hidden');
          countdown.textContent = count;
          document.getElementById('gameContainer').querySelectorAll('div[id^="drawingArea"], div[id^="promptArea"], div[id^="galleryArea"], button[id^="startGameButton"], button[id^="copyInviteCode"], button[id^="leaveRoom"]').forEach(el => el.style.display = 'none');
        } else if (count === 0) {
          clearInterval(countdownInterval);
          countdown.classList.add('hidden');
          document.getElementById('gameContainer').querySelectorAll('div[id^="drawingArea"], div[id^="promptArea"], div[id^="galleryArea"], button[id^="startGameButton"], button[id^="copyInviteCode"], button[id^="leaveRoom"]').forEach(el => el.style.display = '');
          database.ref(`rooms/${roomId}/gameState`).update({
            phase: 'prompt',
            round: 1,
            currentTurn: 0,
            countdown: null
          });
        }
      });

      database.ref(`rooms/${roomId}/ownerId`).once('value', (snapshot) => {
        if (playerId === snapshot.val() && countdownInterval === undefined) {
          let count = 3;
          countdownInterval = setInterval(() => {
            if (count > 0) {
              database.ref(`rooms/${roomId}/gameState`).update({ countdown: count });
              count--;
            } else {
              clearInterval(countdownInterval);
              database.ref(`rooms/${roomId}/gameState`).update({ countdown: 0 });
            }
          }, 1000);
        }
      });
    }

    function updatePlayerList(roomId) {
      const playerList = document.getElementById('playerList');
      const playerListItems = document.getElementById('playerListItems');
      playerList.classList.remove('hidden');
      database.ref(`rooms/${roomId}/players`).on('value', (snapshot) => {
        playerListItems.innerHTML = '';
        snapshot.forEach((childSnapshot) => {
          const player = childSnapshot.val();
          if (player.online) {
            const div = document.createElement('div');
            div.className = 'player-list-item';
            div.innerHTML = `
              <span class="status-indicator status-active"></span>
              <span>${player.name}</span>
            `;
            playerListItems.appendChild(div);
          }
        });
      });
    }

    function startGame(roomId, theme) {
      const canvas = document.getElementById('gameCanvas');
      const ctx = canvas.getContext('2d');
      const drawingArea = document.getElementById('drawingArea');
      const promptArea = document.getElementById('promptArea');
      const galleryArea = document.getElementById('galleryArea');
      const gameStateDisplay = document.getElementById('gameState');
      const timerDisplay = document.getElementById('timer');
      const startButton = document.getElementById('startGameButton');
      const submitDrawingBtn = document.getElementById('submitDrawing');
      const approvalCount = document.getElementById('approvalCount');
      const approvedCount = document.getElementById('approvedCount');
      const totalPlayersSpan = document.getElementById('totalPlayers');
      const progressBarFill = document.getElementById('progressBarFill');
      const promptDisplay = document.getElementById('promptDisplay');
      const startNewRoundBtn = document.getElementById('startNewRound');

      let isDrawing = false;
      let currentTool = 'brush';
      let brushSize = 5;
      let brushColor = '#000000';
      let lastX, lastY;
      let history = [];

      function setTool(tool) {
        currentTool = tool;
        document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelector(`.tool-btn[onclick="setTool('${tool}')"]`).classList.add('active');
      }

      document.getElementById('brushSize').addEventListener('input', (e) => {
        brushSize = e.target.value;
      });

      document.getElementById('brushColor').addEventListener('change', (e) => {
        brushColor = e.target.value;
      });

      function clearCanvas() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        history.push(ctx.getImageData(0, 0, canvas.width, canvas.height));
      }

      canvas.addEventListener('mousedown', startDrawing);
      canvas.addEventListener('mousemove', draw);
      canvas.addEventListener('mouseup', stopDrawing);
      canvas.addEventListener('mouseout', stopDrawing);
      canvas.addEventListener('touchstart', handleTouch);
      canvas.addEventListener('touchmove', handleTouch);
      canvas.addEventListener('touchend', stopDrawing);

      function startDrawing(e) {
        isDrawing = true;
        const pos = getMousePos(canvas, e);
        lastX = pos.x;
        lastY = pos.y;
      }

      function draw(e) {
        if (!isDrawing) return;
        const pos = getMousePos(canvas, e);
        ctx.beginPath();
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.lineWidth = brushSize;
        ctx.strokeStyle = currentTool === 'eraser' ? '#FFFFFF' : brushColor;
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(pos.x, pos.y);
        ctx.stroke();
        lastX = pos.x;
        lastY = pos.y;
      }

      function stopDrawing() {
        if (isDrawing) {
          isDrawing = false;
          history.push(ctx.getImageData(0, 0, canvas.width, canvas.height));
        }
      }

      function getMousePos(canvas, evt) {
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        return {
          x: (evt.clientX - rect.left) * scaleX,
          y: (evt.clientY - rect.top) * scaleY
        };
      }

      function handleTouch(e) {
        e.preventDefault();
        const touch = e.touches[0];
        const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 'mousemove', {
          clientX: touch.clientX,
          clientY: touch.clientY
        });
        canvas.dispatchEvent(mouseEvent);
      }

      database.ref(`rooms/${roomId}/ownerId`).once('value', (snapshot) => {
        if (playerId === snapshot.val()) {
          startButton.classList.remove('hidden');
        } else {
          startButton.classList.add('hidden');
        }
      });

      let timerInterval = null;
      function startTimer(seconds, callback) {
        let timeLeft = seconds;
        timerDisplay.textContent = `Kalan Süre: ${timeLeft}s`;
        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
          timeLeft--;
          timerDisplay.textContent = `Kalan Süre: ${timeLeft}s`;
          if (timeLeft <= 0) {
            clearInterval(timerInterval);
            callback();
          }
        }, 1000);
      }

      function showDrawingArea(prompt) {
        drawingArea.classList.remove('hidden');
        promptArea.classList.add('hidden');
        galleryArea.classList.add('hidden');
        clearCanvas();
        promptDisplay.classList.remove('hidden');
        promptDisplay.textContent = `Çizilecek İpucu: ${prompt || 'Bir şeyler çiz!'}`;
        gameStateDisplay.textContent = 'Çizim Yap';
        submitDrawingBtn.classList.remove('hidden');
        approvalCount.classList.add('hidden');
      }

      function showPromptArea() {
        drawingArea.classList.add('hidden');
        promptArea.classList.remove('hidden');
        galleryArea.classList.add('hidden');
        promptDisplay.classList.add('hidden');
        gameStateDisplay.textContent = 'İpucu Yaz';
        document.getElementById('promptInput').value = '';
      }

      function showGalleryArea(entries) {
        drawingArea.classList.add('hidden');
        promptArea.classList.add('hidden');
        galleryArea.classList.remove('hidden');
        promptDisplay.classList.add('hidden');
        const galleryContainer = document.getElementById('galleryContainer');
        galleryContainer.innerHTML = '';
        let index = 0;

        function showNextImage() {
          if (index < entries.length) {
            const entry = entries[index];
            galleryContainer.innerHTML = `
              <div class="gallery-item">
                <img src="${entry.drawing || ''}" alt="Drawing">
                <div class="gallery-info">
                  <p class="font-semibold text-gray-800 text-lg">İpucu: ${entry.prompt || ''}</p>
                  <p class="text-gray-600">Çizen: <a href="https://th.bing.com/th/id/OIP.BjZhvrmnXlG2eBa4NkU4_gHaHa?rs=1&pid=ImgDetMain" target="_blank">${entry.player}</a></p>
                </div>
              </div>
            `;
            index++;
            setTimeout(showNextImage, 5000); // 5 saniye bekle
          } else {
            startNewRoundBtn.classList.remove('hidden'); // Gösterim bittiğinde buton görünür
          }
        }

        showNextImage();
      }

      window.submitPrompt = function() {
        const prompt = document.getElementById('promptInput').value.trim();
        if (!prompt) {
          alert('Lütfen bir ipucu girin!');
          return;
        }
        database.ref(`rooms/${roomId}/submissions/${playerId}`).update({
          prompt: prompt,
          timestamp: firebase.database.ServerValue.TIMESTAMP
        }).then(() => {
          promptArea.classList.add('hidden');
          gameStateDisplay.textContent = 'Diğer oyuncuları bekliyorsunuz...';
          checkSubmissions('prompt', () => {
            database.ref(`rooms/${roomId}/gameState`).update({
              phase: 'drawing',
              currentTurn: 1
            });
          });
        });
      };

      window.submitDrawing = function() {
        const dataURL = canvas.toDataURL('image/png');
        database.ref(`rooms/${roomId}/submissions/${playerId}`).update({
          drawing: dataURL,
          timestamp: firebase.database.ServerValue.TIMESTAMP,
          approved: false
        }).then(() => {
          submitDrawingBtn.classList.add('hidden');
          approvalCount.classList.remove('hidden');
          checkSubmissions('drawing', () => {
            database.ref(`rooms/${roomId}/gameState`).update({
              phase: 'gallery',
              currentTurn: 0
            });
          });
        });
      };

      function checkSubmissions(phase, callback) {
        database.ref(`rooms/${roomId}/submissions`).on('value', (snapshot) => {
          const submissions = snapshot.val() || {};
          database.ref(`rooms/${roomId}/gameState/playersOrder`).once('value', (orderSnap) => {
            const order = orderSnap.val();
            totalPlayersSpan.textContent = order.length;
            const approved = Object.values(submissions).filter(s => s.approved).length;
            approvedCount.textContent = approved;
            progressBarFill.style.width = `${(approved / order.length) * 100}%`;
            const allSubmitted = order.every(pid => submissions[pid] && (phase === 'prompt' ? submissions[pid].prompt : submissions[pid].drawing));
            if (allSubmitted && phase === 'drawing') {
              order.forEach(pid => {
                database.ref(`rooms/${roomId}/submissions/${pid}`).update({ approved: true });
              });
            }
            if (allSubmitted) callback();
          });
        });
      }

      const gameRef = database.ref(`rooms/${roomId}/gameState`);
      gameRef.on('value', (snapshot) => {
        const state = snapshot.val();
        if (!state) return;

        if (state.countdown > 0) {
          startCountdown(roomId);
        }

        if (state.phase === 'waiting') {
          gameStateDisplay.textContent = 'Oyun başlamadı. En az 2 oyuncu bekleniyor.';
          drawingArea.classList.add('hidden');
          promptArea.classList.add('hidden');
          galleryArea.classList.add('hidden');
          promptDisplay.classList.add('hidden');
          startNewRoundBtn.classList.add('hidden');
        } else if (state.phase === 'prompt') {
          showPromptArea();
          startTimer(20, () => {
            if (document.getElementById('promptInput').value.trim() === '') {
              submitPrompt();
            }
          });
        } else if (state.phase === 'drawing') {
          database.ref(`rooms/${roomId}/submissions`).once('value', (snap) => {
            const submissions = snap.val() || {};
            database.ref(`rooms/${roomId}/gameState/playersOrder`).once('value', (orderSnap) => {
              const order = orderSnap.val();
              const assignments = assignPrompts(order, submissions);
              showDrawingArea(assignments[playerId] || 'Bir şeyler çiz!');
              startTimer(180, () => {
                if (!submitDrawingBtn.classList.contains('hidden')) {
                  submitDrawing();
                }
              });
            });
          });
        } else if (state.phase === 'gallery') {
          clearInterval(timerInterval);
          timerDisplay.textContent = '';
          database.ref(`rooms/${roomId}/submissions`).once('value', (snap) => {
            const submissions = snap.val() || {};
            const entries = state.playersOrder.map(pid => ({
              player: database.ref(`rooms/${roomId}/players/${pid}`).once('value').then(s => s.val().name),
              prompt: submissions[pid]?.prompt,
              drawing: submissions[pid]?.drawing
            }));
            Promise.all(entries).then(results => showGalleryArea(results.map(r => ({ player: r.player, prompt: r.prompt, drawing: r.drawing }))));
          });
        }
      });

      window.startNewRound = function() {
        database.ref(`rooms/${roomId}/ownerId`).once('value', (snapshot) => {
          if (playerId === snapshot.val()) {
            database.ref(`rooms/${roomId}/gameState`).update({
              phase: 'prompt',
              round: firebase.database.ServerValue.increment(1),
              currentTurn: 0,
              countdown: 3
            });
            database.ref(`rooms/${roomId}/submissions`).remove();
            startNewRoundBtn.classList.add('hidden');
          } else {
            alert('Sadece oda sahibi yeni tur başlatabilir!');
          }
        });
      };
    }

    function startChat(roomId) {
      const chatMessages = document.getElementById('chatMessages');
      database.ref(`chats/${roomId}`).on('value', (snapshot) => {
        chatMessages.innerHTML = '';
        snapshot.forEach((childSnapshot) => {
          const message = childSnapshot.val();
          const messageTime = message.timestamp;
          const currentTime = Date.now();
          if (currentTime - messageTime > 300000) {
            childSnapshot.ref.remove();
            return;
          }
          const div = document.createElement('div');
          div.className = `message-bubble ${message.sender === playerName ? 'message-own' : 'message-other'}`;
          const date = new Date(messageTime).toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
          div.innerHTML = `<strong>${message.sender}</strong> <span class="text-xs ${message.sender === playerName ? 'text-white' : 'text-gray-500'}">[${date}]</span><br>${message.text}`;
          chatMessages.appendChild(div);
          chatMessages.scrollTop = chatMessages.scrollHeight;
        });
      });
    }

    function sendMessage() {
      const chatInput = document.getElementById('chatInput');
      let messageText = chatInput.value.trim();
      if (!messageText || !currentRoomId) return;

      const now = Date.now();
      if (now - lastMessageTime < MESSAGE_COOLDOWN) {
        const remaining = Math.ceil((MESSAGE_COOLDOWN - (now - lastMessageTime)) / 1000);
        alert(`Lütfen ${remaining} saniye bekleyin ve tekrar deneyin.`);
        return;
      }

      messageText = messageText.replace(/:smile:/g, '😊').replace(/:heart:/g, '❤️');

      database.ref(`chats/${currentRoomId}`).push({
        sender: playerName,
        text: messageText,
        timestamp: firebase.database.ServerValue.TIMESTAMP
      }).then(() => {
        lastMessageTime = now;
        chatInput.value = '';
      }).catch((error) => {
        console.error('Mesaj gönderme hatası:', error);
        alert('Mesaj gönderilemedi: ' + error.message);
      });
    }

    function updatePlayerCount(roomId) {
      database.ref(`rooms/${roomId}/players`).on('value', (snapshot) => {
        let count = 0;
        snapshot.forEach((childSnapshot) => {
          if (childSnapshot.val().online) count++;
        });
        document.getElementById('playerCount').textContent = `Oyuncu Sayısı: ${count}/${MAX_PLAYERS}`;
      });
    }

    document.getElementById('chatInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') sendMessage();
    });

    auth.onAuthStateChanged((user) => {
      if (user) {
        playerId = user.uid;
        if (!user.emailVerified) {
          showVerificationScreen();
          return;
        }
        database.ref(`users/${playerId}`).once('value', (snapshot) => {
          if (snapshot.exists()) {
            playerName = snapshot.val().username;
            if (!playerName) {
              alert('Kullanıcı adı bulunamadı, lütfen tekrar kayıt olun.');
              auth.signOut();
              return;
            }
            document.getElementById('welcomeUsername').textContent = playerName;
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('verificationScreen').style.display = 'none';
            document.getElementById('lobby').style.display = 'block';
            checkUrlAndJoin();
          } else {
            alert('Kullanıcı verileri bulunamadı, lütfen tekrar kayıt olun.');
            auth.signOut();
          }
        });
      } else {
        document.getElementById('authScreen').style.display = 'block';
        document.getElementById('lobby').style.display = 'none';
        document.getElementById('gameContainer').style.display = 'none';
        document.getElementById('verificationScreen').style.display = 'none';
        showLoginForm();
      }
    });
  </script>
</body>
</html>
