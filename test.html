
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GIF At√∂lyesi</title>
    <script type="text/javascript" src="https://gc.kis.v2.scr.kaspersky-labs.com/FD126C42-EBFA-4E12-B309-BB3FDD723AC1/main.js?attr=dXn6F6fueybNg92B88THx23B8ukhHlwq09dFlykV6-uj1xj3UEzqpB_KTH38gafdkbRJa_3S6cQZdwNCz36o_g" charset="UTF-8"></script>
    <link rel="stylesheet" crossorigin="anonymous" href="https://gc.kis.v2.scr.kaspersky-labs.com/E3E8934C-235A-4B0E-825A-35A08381A191/abn/main.css?attr=aHR0cHM6Ly9idXJha2d0eC5uZW9jaXRpZXMub3JnL3Rlc3N0cw"/>
    <script type="text/javascript" src="https://gc.kis.v2.scr.kaspersky-labs.com/FD126C42-EBFA-4E12-B309-BB3FDD723AC1/main.js?attr=cjrdoNQJ7UZFEhs9bdVf9aGb1axth_1vi_uemlyMPQq7gbC8ZA36NcQq0G0FIo92ZoxHE4uuhYliZsT_KkCCaA" charset="UTF-8"></script>
    <link rel="stylesheet" crossorigin="anonymous" href="https://gc.kis.v2.scr.kaspersky-labs.com/E3E8934C-235A-4B0E-825A-35A08381A191/abn/main.css?attr=aHR0cHM6Ly9idXJha2d0eC5uZW9jaXRpZXMub3JnL2ltYWdl">
    <script src="https://www.google.com/recaptcha/api.js?onload=onloadRecaptchaCallback&render=explicit" async defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.4.0/purify.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); min-height: 100vh; padding: 20px; }
        .header { text-align: center; color: white; margin-bottom: 20px; font-size: 28px; font-weight: bold; }
        .tabs { display: flex; justify-content: center; margin-bottom: 20px; }
        .tab { padding: 10px 20px; background: #007bff; color: white; border-radius: 8px 8px 0 0; margin: 0 5px; cursor: pointer; transition: background 0.3s; }
        .tab.active { background: #0056b3; }
        .tab:hover { background: #0056b3; }
        .container { background: white; border-radius: 15px; padding: 30px; max-width: 1200px; width: 100%; margin: 0 auto; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); animation: fadeIn 0.5s ease-in; position: relative; display: none; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        h2 { text-align: center; color: #333; margin-bottom: 20px; font-size: 24px; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 5px; color: #555; font-weight: 500; }
        .input-group input[type="text"], .input-group input[type="file"] { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; }
        #imageInput { border: 2px dashed #ccc; text-align: center; cursor: pointer; }
        #imageInput:hover { border-color: #007bff; }
        .visibility-options { display: flex; gap: 20px; margin-bottom: 15px; }
        .visibility-options label { display: flex; align-items: center; gap: 5px; color: #555; }
        #preview { max-width: 100%; max-height: 300px; display: none; margin: 15px auto; border-radius: 8px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1); cursor: pointer; }
        #preview.fullscreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; max-width: none; max-height: none; object-fit: contain; background: rgba(0,0,0,0.8); z-index: 1000; margin: 0; }
        #uploadButton { display: block; width: 100%; padding: 12px; background: #007bff; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; transition: background 0.3s; }
        #uploadButton:hover { background: #0056b3; }
        #imageUrl { margin-top: 15px; text-align: center; word-break: break-all; }
        #imageUrl a { color: #007bff; text-decoration: none; font-weight: 500; }
        #imageUrl a:hover { text-decoration: underline; }
        #status { text-align: center; margin: 10px 0; font-size: 14px; }
        .loading { color: #007bff; font-weight: 500; }
        .error { color: #dc3545; }
        .success { color: #28a745; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #007bff; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 10px auto; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #searchInput { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; margin-bottom: 20px; }
        .gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
        .item { border: 1px solid #ddd; border-radius: 8px; overflow: hidden; text-align: center; background: #f9f9f9; }
        .item img { width: 100%; height: 200px; object-fit: cover; }
        .item-info { padding: 10px; }
        .item-info h3 { margin-bottom: 5px; font-size: 16px; }
        .item-info p { margin-bottom: 3px; color: #666; font-size: 14px; }
        .tags { font-size: 12px; }
        .no-results { text-align: center; color: #666; font-style: italic; grid-column: 1 / -1; }
        .back-button, .download-button { position: absolute; top: 20px; padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; transition: background 0.3s; display: none; }
        .back-button:hover, .download-button:hover { background: #218838; }
        .back-button { right: 20px; }
        .download-button { right: 150px; }
        .zoom-icon { position: absolute; top: 20px; left: 20px; font-size: 24px; cursor: pointer; color: #007bff; display: none; }
        .comments-section { margin-top: 20px; padding: 15px; border-top: 1px solid #ddd; display: none; }
        .comments-section h3 { margin-bottom: 10px; font-size: 18px; }
        .comment { border-bottom: 1px solid #eee; padding: 10px 0; word-break: break-word; }
        .comment p { margin-bottom: 5px; max-width: 100%; overflow: hidden; text-overflow: ellipsis; }
        .comment-form { margin-top: 20px; }
        .comment-form textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; margin-bottom: 10px; }
        .comment-form button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer; transition: background 0.3s; }
        .comment-form button:hover { background: #0056b3; }
        .heart-button { padding: 8px 16px; background: #ff4444; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; margin-top: 10px; display: none; }
        .heart-button:hover { background: #cc0000; }
        .heart-count { margin-left: 10px; font-size: 14px; }
        .discover-container { max-width: 100%; height: calc(100vh - 150px); overflow-y: auto; scrollbar-width: none; -ms-overflow-style: none; }
        .discover-container::-webkit-scrollbar { display: none; }
        .discover-item { width: 100%; height: auto; background: #f9f9f9; border: 1px solid #ddd; border-radius: 8px; margin-bottom: 20px; padding: 10px; position: relative; cursor: pointer; transition: transform 0.3s, box-shadow 0.3s; }
        .discover-item:hover { transform: scale(1.02); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .discover-item img { width: 100%; height: auto; border-radius: 4px; }
        .discover-item-info { padding: 10px; text-align: center; }
        .discover-refresh { display: block; margin: 20px auto; padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; }
        .discover-refresh:hover { background: #0056b3; }
        #pageLoader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 9999; display: flex; align-items: center; justify-content: center; }
        #pageLoader .loader { display: block; }
        #recaptchaContainer { margin: 10px 0; text-align: center; display: none; }
    </style>
</head>
<body>
    <div id="pageLoader"><div class="loader"></div></div>
    <div class="header">GIF At√∂lyesi</div>
    <div class="tabs">
        <div class="tab active" data-tab="atolye">At√∂lye</div>
        <div class="tab" data-tab="upload">Y√ºkleme</div>
        <div class="tab" data-tab="discover">Ke≈üfet</div>
    </div>
    <div class="container">
        <button id="backButton" class="back-button" onclick="window.location.hash='';window.location.reload();">Geri D√∂n (At√∂lye)</button>
        <button id="downloadButton" class="download-button" onclick="downloadImage()">ƒ∞ndir</button>
        <div id="zoomIcon" class="zoom-icon">üîç</div>
        <div id="atolye" class="tab-content active">
            <h2>At√∂lye - Onaylanmƒ±≈ü ƒ∞√ßerikler</h2>
            <input type="text" id="searchInput" placeholder="ƒ∞sim veya etiket ara...">
            <div id="gallery" class="gallery"></div>
        </div>
        <div id="upload" class="tab-content">
            <h2>Resim/GIF Y√ºkle</h2>
            <div class="input-group">
                <label for="nameInput">ƒ∞sim (Max 18 Karakter):</label>
                <input type="text" id="nameInput" maxlength="18" placeholder="Resim/GIF ismi girin">
            </div>
            <div class="input-group">
                <label for="tagsInput">Etiketler (#etiket1, #etiket2 - Max 10):</label>
                <input type="text" id="tagsInput" placeholder="Etiketleri virg√ºlle ayƒ±rƒ±n (#√∂rnek, #gif)">
            </div>
            <div class="visibility-options">
                <label><input type="radio" name="visibility" value="public" checked> Herkese A√ßƒ±k (Onay Gerektirir)</label>
                <label><input type="radio" name="visibility" value="private"> Gizli (Sadece Linkle Eri≈üilebilir)</label>
            </div>
            <input type="file" id="imageInput" accept="image/jpeg,image/png,image/gif">
            <img id="preview" alt="Resim/GIF √ñnizleme">
            <div id="recaptchaContainer"></div>
            <button id="uploadButton">Resmi/GIF'i Y√ºkle</button>
            <div id="loader" class="loader"></div>
            <p id="imageUrl"></p>
            <p id="status"></p>
            <div class="comments-section" id="commentsSection">
                <h3>Yorumlar</h3>
                <div id="commentsList"></div>
                <div class="comment-form">
                    <textarea id="commentInput" placeholder="Yorumunuzu girin..." maxlength="35"></textarea>
                    <div id="commentRecaptchaContainer"></div>
                    <button id="submitComment">Yorum G√∂nder</button>
                </div>
            </div>
            <button id="heartButton" class="heart-button">üíñ <span id="heartCount">0</span></button>
            <div id="heartRecaptchaContainer"></div>
        </div>
        <div id="discover" class="tab-content">
            <h2>Ke≈üfet</h2>
            <button id="discoverRefreshButton" class="discover-refresh">Yenile</button>
            <div id="discoverContainer" class="discover-container"></div>
        </div>
    </div>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBDDjiiyKYZd3j0OadLGJtHgPHee5GMKBk",
            authDomain: "burakgtxserver.firebaseapp.com",
            databaseURL: "https://burakgtxserver-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "burakgtxserver",
            storageBucket: "burakgtxserver.firebasestorage.app",
            messagingSenderId: "123896236690",
            appId: "1:123896236690:web:c5189b9fb4e0e19b5d344b",
            measurementId: "G-7XENYB3MHV"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();

        const RECAPTCHA_SITE_KEY = '6Ld7d-crAAAAAFVKdwV06G62REQLnoUkjarTU_R8';
        const RECAPTCHA_THRESHOLD = 0.3;
        let recaptchaWidgetId = null;
        let isSiteVerified = false;

        function onloadRecaptchaCallback() {
            console.log('reCAPTCHA script y√ºklendi!');
            recaptchaWidgetId = grecaptcha.render('recaptchaContainer', {
                'sitekey': RECAPTCHA_SITE_KEY,
                'callback': (token) => {
                    isSiteVerified = true;
                    document.getElementById('recaptchaContainer').style.display = 'none';
                    statusElem.textContent = 'reCAPTCHA doƒürulandƒ±!';
                    statusElem.className = 'success';
                },
                'expired-callback': () => {
                    isSiteVerified = false;
                    document.getElementById('recaptchaContainer').style.display = 'block';
                    statusElem.textContent = 'reCAPTCHA s√ºresi doldu, tekrar doƒürulayƒ±n!';
                    statusElem.className = 'error';
                }
            });
            document.getElementById('recaptchaContainer').style.display = 'block';
        }

        let userId = null;
        const imageInput = document.getElementById('imageInput');
        const nameInput = document.getElementById('nameInput');
        const tagsInput = document.getElementById('tagsInput');
        const preview = document.getElementById('preview');
        const uploadButton = document.getElementById('uploadButton');
        const imageUrlElem = document.getElementById('imageUrl');
        const statusElem = document.getElementById('status');
        const loader = document.getElementById('loader');
        const gallery = document.getElementById('gallery');
        const searchInput = document.getElementById('searchInput');
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const backButton = document.getElementById('backButton');
        const downloadButton = document.getElementById('downloadButton');
        const zoomIcon = document.getElementById('zoomIcon');
        const commentsSection = document.getElementById('commentsSection');
        const commentsList = document.getElementById('commentsList');
        const commentInput = document.getElementById('commentInput');
        const submitComment = document.getElementById('submitComment');
        const heartButton = document.getElementById('heartButton');
        const heartCount = document.getElementById('heartCount');
        const discoverContainer = document.getElementById('discoverContainer');
        const discoverRefreshButton = document.getElementById('discoverRefreshButton');
        const pageLoader = document.getElementById('pageLoader');
        const container = document.querySelector('.container');
        const header = document.querySelector('.header');
        const tabsContainer = document.querySelector('.tabs');
        let allItems = [];
        let currentImageId = null;

        auth.signInAnonymously().then((userCredential) => {
            userId = userCredential.user.uid;
            localStorage.setItem('userId', userId);
            showSite();
        }).catch((error) => {
            console.error('Anonim auth hatasƒ±:', error);
            statusElem.textContent = 'Kimlik doƒürulama hatasƒ±: ' + error.message;
            statusElem.className = 'error';
        });

        function showSite() {
            pageLoader.style.display = 'none';
            header.style.display = 'block';
            tabsContainer.style.display = 'flex';
            container.style.display = 'block';
            if (!isSiteVerified) document.getElementById('recaptchaContainer').style.display = 'block';
            loadApproved();
        }

        function checkRateLimit(action) {
            const key = action + '_lastTime';
            const lastTime = parseInt(localStorage.getItem(key)) || 0;
            const cooldown = action === 'comment' ? 8 * 60 * 1000 : 60 * 1000;
            if (Date.now() - lastTime < cooldown) return false;
            localStorage.setItem(key, Date.now());
            return true;
        }

        function verifyRecaptcha(action, callback) {
            const containerId = action === 'upload' ? 'recaptchaContainer' : action === 'comment' ? 'commentRecaptchaContainer' : 'heartRecaptchaContainer';
            const widgetId = grecaptcha.render(containerId, {
                'sitekey': RECAPTCHA_SITE_KEY,
                'callback': (token) => {
                    grecaptcha.reset(widgetId);
                    document.getElementById(containerId).style.display = 'none';
                    callback(token);
                },
                'expired-callback': () => {
                    document.getElementById(containerId).style.display = 'block';
                    statusElem.textContent = `${action} i√ßin reCAPTCHA s√ºresi doldu, tekrar doƒürulayƒ±n!`;
                    statusElem.className = 'error';
                }
            });
            document.getElementById(containerId).style.display = 'block';
        }

        function compressImage(file, maxSizeMB, callback) {
            if (!file.type.startsWith('image/') || file.size > maxSizeMB * 1024 * 1024) {
                callback(null, new Error('Ge√ßersiz dosya t√ºr√º veya boyutu!'));
                return;
            }
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    let width = img.width;
                    let height = img.height;
                    const maxSizeBytes = maxSizeMB * 1024 * 1024;
                    const isGif = file.type === 'image/gif';
                    let dataUrl = e.target.result;
                    if (!isGif) {
                        const scale = Math.min(1, Math.sqrt(maxSizeBytes / (width * height * 4)));
                        if (scale < 1) {
                            width *= scale;
                            height *= scale;
                        }
                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        let quality = 0.9;
                        do {
                            dataUrl = canvas.toDataURL('image/jpeg', quality);
                            quality -= 0.1;
                        } while (dataUrl.length / 4 * 3 > maxSizeBytes && quality > 0.1);
                    }
                    if (dataUrl.length / 4 * 3 > maxSizeBytes) {
                        callback(null, new Error('Dosya boyutu √ßok b√ºy√ºk!'));
                    } else {
                        callback(dataUrl, null);
                    }
                };
                img.onerror = () => callback(null, new Error('Dosya y√ºklenemedi!'));
            };
            reader.onerror = () => callback(null, new Error('Dosya okunamadƒ±!'));
            reader.readAsDataURL(file);
        }

        function parseTags(tagsString) {
            if (!tagsString) return [];
            const tags = tagsString.split(',').map(tag => tag.trim()).filter(tag => tag.startsWith('#') && !tag.includes(' '));
            return tags.slice(0, 10);
        }

        imageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.onerror = () => {
                    statusElem.textContent = 'Dosya √∂nizlemesi olu≈üturulamadƒ±!';
                    statusElem.className = 'error';
                };
                reader.readAsDataURL(file);
            }
        });

        uploadButton.addEventListener('click', () => {
            if (!userId || !isSiteVerified) {
                statusElem.textContent = 'L√ºtfen √∂nce siteyi doƒürulayƒ±n!';
                statusElem.className = 'error';
                return;
            }
            const file = imageInput.files[0];
            const name = nameInput.value.trim();
            const tagsString = tagsInput.value.trim();
            const tags = parseTags(tagsString);
            const visibility = document.querySelector('input[name="visibility"]:checked').value;
            if (!file || name.length === 0 || name.length > 18 || tags.length > 10) {
                statusElem.textContent = 'Ge√ßersiz giri≈üler!';
                statusElem.className = 'error';
                return;
            }
            if (!checkRateLimit('upload')) {
                statusElem.textContent = 'Y√ºkleme sƒ±nƒ±rƒ± a≈üƒ±ldƒ± (1 dakika bekleyin)!';
                statusElem.className = 'error';
                return;
            }
            statusElem.textContent = 'Y√ºkleniyor...';
            statusElem.className = 'loading';
            loader.style.display = 'block';
            uploadButton.disabled = true;
            verifyRecaptcha('upload', (token) => {
                compressImage(file, 5, (base64Data, error) => {
                    if (error) {
                        statusElem.textContent = error.message;
                        statusElem.className = 'error';
                        loader.style.display = 'none';
                        uploadButton.disabled = false;
                        return;
                    }
                    database.ref('bannedUsers/' + userId).once('value').then(snapshot => {
                        if (snapshot.val()) {
                            statusElem.textContent = 'Hesap banlanmƒ±≈ü!';
                            statusElem.className = 'error';
                            loader.style.display = 'none';
                            uploadButton.disabled = false;
                            return;
                        }
                        const imageId = visibility === 'private' ? crypto.randomUUID().replace(/-/g, '') : database.ref('images').push().key;
                        const data = {
                            base64: base64Data,
                            type: file.type,
                            name: DOMPurify.sanitize(name),
                            tags: tags,
                            timestamp: firebase.database.ServerValue.TIMESTAMP,
                            public: visibility === 'public',
                            approved: visibility === 'private',
                            hearts: 0,
                            heartedBy: { [userId]: true },
                            comments: {},
                            recaptchaToken: token,
                            userId: userId
                        };
                        database.ref('images/' + imageId).set(data).then(() => {
                            let message = visibility === 'private' ? `Link: <a href="https://burakgtx.neocities.org/image.html#${imageId}" target="_blank">https://burakgtx.neocities.org/image.html#${imageId}</a>` : 'Onay bekleniyor.';
                            imageUrlElem.innerHTML = message;
                            statusElem.textContent = 'Ba≈üarƒ±lƒ±!';
                            statusElem.className = 'success';
                            loader.style.display = 'none';
                            uploadButton.disabled = false;
                            preview.src = base64Data;
                            preview.style.display = 'block';
                            if (visibility === 'public') loadApproved();
                        }).catch((error) => {
                            statusElem.textContent = 'Y√ºkleme hatasƒ±: ' + error.message;
                            statusElem.className = 'error';
                            loader.style.display = 'none';
                            uploadButton.disabled = false;
                        });
                    });
                });
            });
        });

        function loadApproved() {
            if (!userId) return;
            loader.style.display = 'block';
            database.ref('images').orderByChild('timestamp').once('value').then((snapshot) => {
                allItems = [];
                gallery.innerHTML = '';
                const data = snapshot.val();
                if (!data) {
                    gallery.innerHTML = '<p class="no-results">Hen√ºz i√ßerik yok.</p>';
                    loader.style.display = 'none';
                    return;
                }
                Object.entries(data).forEach(([key, item]) => {
                    if (item.public && item.approved) {
                        allItems.push({ key, ...item, url: `https://burakgtx.neocities.org/image.html#${key}` });
                    }
                });
                allItems.sort((a, b) => b.timestamp - a.timestamp);
                displayItems(allItems);
                loader.style.display = 'none';
            }).catch((error) => {
                gallery.innerHTML = '<p class="no-results">Y√ºkleme hatasƒ±.</p>';
                loader.style.display = 'none';
            });
        }

        function displayItems(items) {
            gallery.innerHTML = '';
            if (items.length === 0) {
                gallery.innerHTML = '<p class="no-results">Arama sonucu bulunamadƒ±.</p>';
                return;
            }
            items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'item';
                const tagsHtml = item.tags && item.tags.length > 0 ? `<p class="tags">${DOMPurify.sanitize(item.tags.join(' '))}</p>` : '';
                const nameHtml = DOMPurify.sanitize(item.name || 'ƒ∞simsiz');
                div.innerHTML = `
                    <a href="${item.url}"><img src="${item.base64}" alt="${nameHtml}"></a>
                    <div class="item-info">
                        <h3>${nameHtml}</h3>
                        ${tagsHtml}
                        <p>${new Date(item.timestamp).toLocaleDateString('tr-TR')}</p>
                    </div>
                `;
                gallery.appendChild(div);
            });
        }

        searchInput.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            const filtered = allItems.filter(item => (item.name && item.name.toLowerCase().includes(query)) || (item.tags && item.tags.some(tag => tag.toLowerCase().includes(query))));
            displayItems(filtered);
        });

        const imageIdFromHash = window.location.hash.substring(1);
        if (imageIdFromHash && userId) {
            statusElem.textContent = 'Y√ºkleniyor...';
            statusElem.className = 'loading';
            loader.style.display = 'block';
            preview.style.display = 'none';
            tabs.forEach(t => t.style.display = 'none');
            tabContents.forEach(c => c.classList.remove('active'));
            document.getElementById('upload').classList.add('active');
            document.getElementById('upload').querySelectorAll('input, button').forEach(el => el.style.display = 'none');
            document.getElementById('upload').querySelector('h2').textContent = 'G√∂r√ºnt√ºleme Modu';
            backButton.style.display = 'block';
            downloadButton.style.display = 'block';
            zoomIcon.style.display = 'block';
            commentsSection.style.display = 'block';
            heartButton.style.display = 'inline-block';
            database.ref('images/' + imageIdFromHash).once('value').then((snapshot) => {
                const data = snapshot.val();
                if (data && data.base64) {
                    currentImageId = imageIdFromHash;
                    if (data.approved || !data.public) {
                        preview.src = data.base64;
                        preview.style.display = 'block';
                    } else {
                        preview.style.display = 'none';
                        statusElem.textContent = 'Onay bekleniyor.';
                        statusElem.className = 'loading';
                    }
                    let extraInfo = `G√∂r√ºnt√ºlenen dosya: <a href="${window.location.href}">${window.location.href}</a>`;
                    if (data.name) extraInfo += `<br>ƒ∞sim: ${DOMPurify.sanitize(data.name)}`;
                    if (data.tags && data.tags.length > 0) extraInfo += `<br>Etiketler: ${DOMPurify.sanitize(data.tags.join(', '))}`;
                    imageUrlElem.innerHTML = extraInfo;
                    statusElem.textContent = '';
                    loader.style.display = 'none';
                    loadComments(imageIdFromHash);
                    loadHearts(imageIdFromHash);
                } else {
                    statusElem.textContent = 'Dosya bulunamadƒ±!';
                    statusElem.className = 'error';
                    loader.style.display = 'none';
                }
            }).catch((error) => {
                statusElem.textContent = 'Hata: ' + error.message;
                statusElem.className = 'error';
                loader.style.display = 'none';
            });
        } else {
            loadApproved();
        }

        function loadComments(id) {
            database.ref('images/' + id + '/comments').once('value').then((snapshot) => {
                commentsList.innerHTML = '';
                const comments = snapshot.val();
                if (comments) {
                    Object.values(comments).forEach(comment => {
                        if (comment.approved) {
                            const div = document.createElement('div');
                            div.className = 'comment';
                            const text = DOMPurify.sanitize(comment.text);
                            div.innerHTML = `<p>${text}</p><p style="font-size: 12px; color: #999;">- ${comment.userId.slice(0, 8)}... (${new Date(comment.timestamp).toLocaleString('tr-TR')})</p>`;
                            commentsList.appendChild(div);
                        }
                    });
                } else {
                    commentsList.innerHTML = '<p>Hen√ºz yorum yok.</p>';
                }
            });
        }

        submitComment.addEventListener('click', () => {
            if (!userId || !currentImageId || !isSiteVerified) {
                statusElem.textContent = 'L√ºtfen √∂nce siteyi doƒürulayƒ±n!';
                statusElem.className = 'error';
                return;
            }
            const text = commentInput.value.trim();
            if (text.length === 0 || text.length > 35) return;
            if (!checkRateLimit('comment')) {
                statusElem.textContent = 'Yorum sƒ±nƒ±rƒ± a≈üƒ±ldƒ± (8 dakika bekleyin)!';
                statusElem.className = 'error';
                return;
            }
            verifyRecaptcha('comment', (token) => {
                database.ref('bannedUsers/' + userId).once('value').then(snapshot => {
                    if (snapshot.val()) {
                        statusElem.textContent = 'Hesap banlanmƒ±≈ü!';
                        statusElem.className = 'error';
                        return;
                    }
                    const commentId = database.ref('images/' + currentImageId + '/comments').push().key;
                    database.ref('images/' + currentImageId + '/comments/' + commentId).set({
                        text: DOMPurify.sanitize(text),
                        userId: userId,
                        timestamp: firebase.database.ServerValue.TIMESTAMP,
                        approved: false,
                        recaptchaToken: token
                    }).then(() => {
                        commentInput.value = '';
                        statusElem.textContent = 'Yorum g√∂nderildi, onay bekliyor!';
                        statusElem.className = 'success';
                        loadComments(currentImageId);
                    }).catch((error) => {
                        statusElem.textContent = 'Hata: ' + error.message;
                        statusElem.className = 'error';
                    });
                });
            });
        });

        function loadHearts(id) {
            database.ref('images/' + id).once('value').then((snapshot) => {
                const data = snapshot.val();
                heartCount.textContent = data.hearts || 0;
                if (data.heartedBy && data.heartedBy[userId]) {
                    heartButton.disabled = true;
                    heartButton.innerHTML = 'üíñ <span id="heartCount">Beƒüenildi</span>';
                } else {
                    heartButton.disabled = false;
                    heartButton.innerHTML = 'üíñ <span id="heartCount"></span>';
                }
            });
        }

        heartButton.addEventListener('click', () => {
            if (!userId || !currentImageId || !isSiteVerified || heartButton.disabled) {
                statusElem.textContent = 'L√ºtfen √∂nce siteyi doƒürulayƒ±n!';
                statusElem.className = 'error';
                return;
            }
            if (!checkRateLimit('heart')) {
                statusElem.textContent = 'Beƒüeni sƒ±nƒ±rƒ± a≈üƒ±ldƒ±!';
                statusElem.className = 'error';
                return;
            }
            verifyRecaptcha('heart', (token) => {
                const updates = {};
                updates['images/' + currentImageId + '/heartedBy/' + userId] = true;
                updates['images/' + currentImageId + '/hearts'] = firebase.database.ServerValue.increment(1);
                database.ref().update(updates).then(() => {
                    loadHearts(currentImageId);
                }).catch((error) => {
                    statusElem.textContent = 'Hata: ' + error.message;
                    statusElem.className = 'error';
                });
            });
        });

        function loadDiscover(random = false) {
            if (!userId) return;
            loader.style.display = 'block';
            discoverContainer.innerHTML = '';
            database.ref('images').once('value').then((snapshot) => {
                const data = snapshot.val();
                if (data) {
                    let items = Object.entries(data).map(([key, item]) => ({ key, ...item }))
                        .filter(item => item.public && item.approved);
                    if (random) items = items.sort(() => Math.random() - 0.5);
                    else items = items.sort((a, b) => {
                        const aScore = (a.hearts || 0) + (Object.keys(a.comments || {}).length * 2);
                        const bScore = (b.hearts || 0) + (Object.keys(b.comments || {}).length * 2);
                        return bScore - aScore;
                    });
                    items = items.slice(0, 20);
                    items.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'discover-item';
                        div.onclick = () => window.location.href = `https://burakgtx.neocities.org/image.html#${item.key}`;
                        const nameHtml = DOMPurify.sanitize(item.name || 'ƒ∞simsiz');
                        div.innerHTML = `
                            <img src="${item.base64}" alt="${nameHtml}">
                            <div class="discover-item-info">
                                <h3>${nameHtml}</h3>
                            </div>
                        `;
                        discoverContainer.appendChild(div);
                    });
                }
                loader.style.display = 'none';
            }).catch((error) => {
                loader.style.display = 'none';
            });
        }

        discoverRefreshButton.addEventListener('click', () => {
            loadDiscover(true);
        });

        zoomIcon.addEventListener('click', () => {
            preview.classList.toggle('fullscreen');
        });
        preview.addEventListener('click', () => {
            if (preview.classList.contains('fullscreen')) preview.classList.remove('fullscreen');
        });

        function downloadImage() {
            if (preview.src) {
                const a = document.createElement('a');
                a.href = preview.src;
                a.download = 'image';
                a.click();
            }
        }

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                if (!userId) return;
                tabs.forEach(t => t.classList.remove('active'));
                tabContents.forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab).classList.add('active');
                backButton.style.display = 'none';
                downloadButton.style.display = 'none';
                zoomIcon.style.display = 'none';
                commentsSection.style.display = 'none';
                heartButton.style.display = 'none';
                if (tab.dataset.tab === 'atolye') loadApproved();
                else if (tab.dataset.tab === 'discover') loadDiscover();
            });
        });

        if (userId && !imageIdFromHash) {
            const activeTab = document.querySelector('.tab.active').dataset.tab;
            if (activeTab === 'atolye') loadApproved();
            else if (activeTab === 'discover') loadDiscover();
        }
    </script>
</body>
</html>
